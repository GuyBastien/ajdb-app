<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gestion des Joueurs - AJDB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script>
        if (!localStorage.getItem('isLoggedIn')) { window.location.href = '/'; }
    </script>

    <style>
        :root { --primary-blue: #120491; --secondary-green: #1e7e34; --accent-red: #e11d48; }
        body { background: radial-gradient(circle at top, #f8f9fa 0%, #e9ecef 100%); font-family: 'Inter', sans-serif; padding-top: 85px; min-height: 100vh; }
        .card { border: none; border-radius: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .section-title { color: var(--primary-blue); font-weight: 800; position: relative; padding-bottom: 10px; }
        .section-title::after { content: ''; position: absolute; left: 0; bottom: 0; width: 40px; height: 4px; background: var(--secondary-green); border-radius: 2px; }
        .photo-container { position: relative; width: 130px; height: 160px; margin: 0 auto; }
        .photo-preview { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: #f0f0f0; }
        .form-label { font-weight: 600; font-size: 0.85rem; color: #4a5568; margin-bottom: 0.4rem; }
        .required::after { content: "*"; color: var(--accent-red); margin-left: 4px; }
        .table thead { background: var(--primary-blue); color: white; }
        .table-container { border-radius: 15px; overflow: hidden; border: 1px solid #eee; }
        .badge-poste { background: #e2e8f0; color: #475569; font-weight: 600; padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; }
        .img-table { width: 40px; height: 40px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <nav class="navbar fixed-top" style="background: var(--primary-blue) !important; height: 75px; border-bottom: 3px solid var(--secondary-green);">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand fw-bold text-white m-0" href="Accueil.html">⚽ AJDB</a>
            <div class="nav-icons-group" style="display: flex; gap: 8px;">
                <a class="nav-link-icon" href="Accueil.html" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: white; background: rgba(255,255,255,0.1); text-decoration: none;"><i class="fas fa-home"></i></a>
                <a class="nav-link-icon" href="Tableau_Bord.html" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: white; background: rgba(255,255,255,0.1); text-decoration: none;"><i class="fas fa-chart-line"></i></a>
                <a class="nav-link-icon" href="Enregistrer_joueur.html" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: white; background: var(--secondary-green); text-decoration: none;"><i class="fas fa-users"></i></a>
                <a class="nav-link-icon" id="logoutBtn" href="#" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: white; background: rgba(255,255,255,0.1); text-decoration: none;"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </div>
    </nav>

    <main class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-11">
                <div class="card p-4 p-md-5 mb-5">
                    <div class="row">
                        <div class="col-md-3 text-center border-end">
                            <div class="photo-container mb-3">
                                <img id="photoPreview" class="photo-preview" src="/images/placeholder-player.png" alt="Aperçu">
                            </div>
                            <label for="photo" class="btn btn-outline-primary btn-sm w-100 mb-2"><i class="fas fa-image me-2"></i>Photo</label>
                            <input id="photo" type="file" accept="image/*" class="d-none">
                        </div>
                        <div class="col-md-9">
                            <h3 class="section-title mb-4">Nouveau Joueur</h3>
                            <form id="playerForm">
                                <div class="row g-3">
                                    <div class="col-md-6"><label class="form-label required">Nom</label><input id="nom" class="form-control" required></div>
                                    <div class="col-md-6"><label class="form-label required">Prénom</label><input id="prenom" class="form-control" required></div>
                                    <div class="col-md-3"><label class="form-label">Âge</label><input id="age" type="number" class="form-control"></div>
                                    <div class="col-md-5"><label class="form-label">Poste</label>
                                        <select id="poste" class="form-select">
                                            <option value="">Poste...</option>
                                            <option value="Gardien">Gardien</option>
                                            <option value="Défenseur">Défenseur</option>
                                            <option value="Milieu">Milieu</option>
                                            <option value="Attaquant">Attaquant</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4"><label class="form-label">Numéro</label><input id="numero" type="number" class="form-control"></div>
                                    <div class="col-md-6"><label class="form-label">Équipe</label><select id="equipe" class="form-select"><option value="">Non assigné</option></select></div>
                                    <div class="col-md-6"><label class="form-label">Téléphone</label><input id="telephone" class="form-control" placeholder="+509..."></div>
                                    <div class="col-12 mt-4">
                                        <div id="formAlert" class="alert d-none py-2 small"></div>
                                        <button type="submit" id="submitBtn" class="btn btn-primary px-5 fw-bold" style="background: var(--primary-blue); border:none;">Enregistrer</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="section-title mb-0">Effectif Actuel</h4>
                        <input id="searchPlayer" class="form-control form-control-sm w-25" placeholder="Rechercher...">
                    </div>
                    <div class="table-container">
                        <table id="playersTable" class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th class="ps-3">#</th>
                                    <th>Photo</th>
                                    <th>Joueur</th>
                                    <th>Équipe</th>
                                    <th>Poste</th>
                                    <th class="text-center">Numéro</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="playerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Fiche Joueur</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center" id="playerModalBody"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- LOGOUT ---
        const logoutBtn = document.getElementById('logoutBtn');
        if(logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('isLoggedIn');
                window.location.href = '/';
            });
        }

        // --- PHOTO PREVIEW ---
        const photoInput = document.getElementById('photo');
        const photoPreview = document.getElementById('photoPreview');
        photoInput.addEventListener('change', () => {
            const f = photoInput.files[0];
            if (f) {
                const reader = new FileReader();
                reader.onload = () => { photoPreview.src = reader.result; };
                reader.readAsDataURL(f);
            }
        });

        // --- DATA LOADING ---
        async function loadTeams() {
            try {
                const res = await fetch('/api/equipes');
                if (res.ok) {
                    const teams = await res.json();
                    const sel = document.getElementById('equipe');
                    teams.forEach(t => sel.add(new Option(t.nomEquipe, t.ID_Equipe || t.id)));
                }
            } catch (err) {}
        }

        async function loadPlayers() {
            const tbody = document.querySelector('#playersTable tbody');
            const search = (document.getElementById('searchPlayer').value || '').toLowerCase();
            try {
                const res = await fetch('/api/joueurs');
                const players = await res.json();
                const filtered = players.filter(p => (p.nom + ' ' + p.prenom + ' ' + (p.team_name || '')).toLowerCase().includes(search));
                tbody.innerHTML = '';
                filtered.forEach((p, i) => {
                    const pic = p.photo || '/images/placeholder-player.png';
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr>
                            <td class="ps-3 text-muted">${i+1}</td>
                            <td><img src="${pic}" class="img-table"></td>
                            <td class="fw-bold">${p.prenom} ${p.nom.toUpperCase()}</td>
                            <td><span class="text-primary fw-medium">${p.team_name || '—'}</span></td>
                            <td><span class="badge-poste">${p.poste || '—'}</span></td>
                            <td class="text-center fw-bold">${p.numero ?? '—'}</td>
                            <td class="text-end pe-3">
                                <button class="btn btn-sm btn-outline-info border-0 me-1" onclick="viewDetails(${JSON.stringify(p).replace(/"/g, '&quot;')})"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-outline-danger border-0" onclick="deletePlayer(${p.Id_joueur})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `);
                });
            } catch (err) { tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erreur.</td></tr>'; }
        }

        // --- ACTIONS ---
        function viewDetails(p) {
            document.getElementById('modalTeamLogo').src = team.logo || '/images/placeholder-team.png';
    
            document.getElementById('modalTeamName').textContent = team.nomEquipe;
            const body = document.getElementById('playerModalBody');
            const pic = p.photo || '/images/placeholder-player.png';
            body.innerHTML = `
                <img src="${pic}" class="rounded-circle mb-3 shadow-sm" style="width:100px; height:100px; object-fit:cover; border:3px solid #f8f9fa;">
                <h4 class="fw-bold mb-0">${p.prenom} ${p.nom.toUpperCase()}</h4>
                <p class="text-muted">Numéro ${p.numero || 'N/A'}</p>
                <div class="row text-start g-3 mt-2">
                    <div class="col-6 small"><strong>Âge:</strong> ${p.age || '—'}</div>
                    <div class="col-6 small"><strong>Tel:</strong> ${p.telephone || '—'}</div>
                    <div class="col-6 small"><strong>Poste:</strong> ${p.poste || '—'}</div>
                    <div class="col-6 small"><strong>Santé:</strong> ${p.maladie_courante || 'RAS'}</div>
                </div>`;
            new bootstrap.Modal(document.getElementById('playerModal')).show();
        }

        document.getElementById('playerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const alertEl = document.getElementById('formAlert');
            btn.disabled = true;
            btn.innerHTML = 'Envoi...';

            const payload = {
                nom: document.getElementById('nom').value,
                prenom: document.getElementById('prenom').value,
                age: document.getElementById('age').value || null,
                poste: document.getElementById('poste').value,
                numero: document.getElementById('numero').value || null,
                telephone: document.getElementById('telephone').value,
                ID_Equipe: document.getElementById('equipe').value || null,
                photo: photoPreview.src.startsWith('data:') ? photoPreview.src : null
            };

            try {
                const res = await fetch('/api/joueurs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    alertEl.className = "alert alert-success"; alertEl.textContent = "Joueur enregistré !";
                    alertEl.classList.remove('d-none');
                    e.target.reset(); photoPreview.src = '/images/placeholder-player.png';
                    loadPlayers();
                }
            } catch (err) { alert('Erreur réseau'); }
            finally { btn.disabled = false; btn.innerHTML = 'Enregistrer'; }
        });

        async function deletePlayer(id) {
            if (confirm('Supprimer ?')) {
                await fetch(`/api/joueurs/${id}`, { method: 'DELETE' });
                loadPlayers();
            }
        }

        document.getElementById('searchPlayer').oninput = loadPlayers;
        loadTeams();
        loadPlayers();
    </script>
</body>
</html>